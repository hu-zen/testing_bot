//=============================Motor Controll with Rapid Staged Deceleration===============================
// Versi 5.0 - Deselerasi sangat cepat (mikrodetik) namun tidak instan.
//=========================================================================================================

#include <Servo.h>
#include <HB25MotorControl.h>
#include <ros.h>
#include <geometry_msgs/Twist.h>

const byte controlPinL = 6;
const byte controlPinR = 7;

HB25MotorControl motorControlL(controlPinL);
HB25MotorControl motorControlR(controlPinR);

ros::NodeHandle nh;

// "Memori" untuk menyimpan kecepatan terakhir
int current_left_speed = 0;
int current_right_speed = 0;

void twistCallback(const geometry_msgs::Twist& twist_msg) {
  // Kalkulasi kecepatan target dari ROS (tidak diubah)
  int linear_speed = (int)(twist_msg.linear.x * 300);
  int angular_speed = (int)(twist_msg.angular.z * 300);
  int left_speed = linear_speed - angular_speed;
  int right_speed = linear_speed + angular_speed;

  left_speed = constrain(left_speed, -500, 500);
  right_speed = constrain(right_speed, -500, 500);

  // --- LOGIKA RAPID STAGED DECELERATION (RSD) ---

  // Untuk Motor Kiri
  if (left_speed == 0 && current_left_speed != 0) {
    // Jika perintahnya BERHENTI dan motor SEDANG BERGERAK...
    // Lakukan penurunan dalam beberapa tahap cepat.
    motorControlL.moveAtSpeed(current_left_speed / 3);
    delayMicroseconds(200); // Jeda 200 mikrodetik (0.0002 detik)
    motorControlL.moveAtSpeed(0);
  } else {
    // Jika tidak, jalankan perintah secara langsung (responsif).
    motorControlL.moveAtSpeed(left_speed);
  }

  // Untuk Motor Kanan
  if (right_speed == 0 && current_right_speed != 0) {
    motorControlR.moveAtSpeed(current_right_speed / 3);
    delayMicroseconds(200);
    motorControlR.moveAtSpeed(0);
  } else {
    motorControlR.moveAtSpeed(right_speed);
  }

  // Update "memori" kecepatan dengan target yang baru
  current_left_speed = left_speed;
  current_right_speed = right_speed;
}

ros::Subscriber<geometry_msgs::Twist> sub("cmd_vel", &twistCallback);

void setup() {
  nh.getHardware()->setBaud(115200);
  nh.initNode();
  nh.subscribe(sub);
  motorControlL.begin();
  motorControlR.begin();
}

void loop() {
  nh.spinOnce();
}
